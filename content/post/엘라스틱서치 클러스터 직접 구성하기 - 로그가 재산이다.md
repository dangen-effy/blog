---
title: "ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ í´ëŸ¬ìŠ¤í„° ì§ì ‘ êµ¬ì„±í•˜ê¸° - ë¡œê·¸ê°€ ì¬ì‚°ì´ë‹¤"
description: "ë„ì»¤ ì»´í¬ì¦ˆë¡œ ì—˜ë¼ìŠ¤í‹± ì„œì¹˜ í´ëŸ¬ìŠ¤í„°ë¥¼ ë„ì›Œë´…ì‹œë‹¤"
tags: ["DevOps", "Docker", "Docker Compose", "docker-compose", "log"]
categories: ["DevOps", "Elastic", "Elasticsearch"]
date: 2020-02-23T15:27:02+09:00
draft: false
---

ë¦¬ëª¨íŠ¸ëª¬ìŠ¤í„°ëŠ” ë‹¤ì–‘í•œ í˜•íƒœì˜ ë¡œê·¸ë¥¼ ìˆ˜ì§‘í•´ ì ìˆ˜ë¥¼ ë§¤ê²¨ í†µí™”/ë°©ì†¡ì˜ í’ˆì§ˆì„ ì¸¡ì •í•©ë‹ˆë‹¤. ğŸ“ˆ

ì˜ˆë¥¼ ë“¤ì–´, ì–´ëŠ êµ¬ê°„ì—ì„œ íŒ¨í‚· ì†ì‹¤ì´ ë§ì´ ì¼ì–´ë‚˜ëŠ”ì§€ í˜¹ì€ ì–´ë–¤ ë„¤íŠ¸ì›Œí¬ ìƒí™©ì—ì„œ ì‹¤íŒ¨ìœ¨ì´ ë†’ì€ì§€ ë“± ë‹¤ì–‘í•œ ì§€í‘œë¥¼ ëª¨ë¸ë§í•˜ê³  ê°œì„  ì ì„ ë„ì¶œí•©ë‹ˆë‹¤. ì¦‰ ë¡œê·¸ì˜ ì†ì‹¤ì€ ì €í¬ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸ì˜ ì†ì‹¤ì— ì§ê²°ë©ë‹ˆë‹¤. ë•Œë¬¸ì— ì–´ë–»ê²Œë“  ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ê°™ì€ ë¡œê·¸ ì €ì¥ì†Œì˜ ì•ˆì •ì„±ì„ í™•ë³´ í•˜ëŠ”ë° ëª©ìˆ¨ì„ ê±¸ì–´ì•¼ í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ê°€ ì•ˆì •ì ì¸ ìƒíƒœì—ì„œ ë‚¨ëŠ”ê±´ ë¡œê·¸ ë°–ì— ì—†ê±°ë“ ìš” :)

ì´ì œë¶€í„° ì œê°€ ë¦¬ëª¨íŠ¸ëª¬ìŠ¤í„°ì—ì„œ ì‹±ê¸€ ë…¸ë“œë¡œ ìš´ì˜í•˜ë˜ ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ë¥¼ ë©€í‹° í´ëŸ¬ìŠ¤í„° í˜•íƒœë¡œ ì „í™˜ì‹œí‚¨ ê²½í—˜ì„ í† ëŒ€ë¡œ í´ëŸ¬ìŠ¤í„° êµ¬ì¶• ë°©ë²•ì„ ê°„ëµíˆ í’€ì–´ ë‚˜ê°€ë ¤ê³  í•©ë‹ˆë‹¤.

ì›ë¡ ì ì¸ ì§ˆë¬¸ë¶€í„° ì‹œì‘í•˜ë©´ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•˜ëŠ” ì´ìœ ëŠ” ë­˜ ê¹Œìš”? ì‹±ê¸€ ë…¸ë“œë¡œ ì˜ ëŒì•„ê°€ë˜ ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ë¥¼ êµ³ì´ ë©€í‹° í´ëŸ¬ìŠ¤í„°ë¡œ ì—…ê·¸ë ˆì´ë“œ ì‹œí‚¨ ì´ìœ ê°€ ë­˜ ê¹Œìš”?

**ì²«ì§¸ë¡œ** ë‹¤ì¤‘ ê°€ìš©ì˜ì—­ì— í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•ì‹œì¼œ ê°€ìš©ì„±ì„ í–¥ìƒ ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë§Œì•½ ì‹±ê¸€ ë…¸ë“œë¡œ ëŒì•„ê°€ë˜ ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ê°€ ì¢…ë£Œë˜ê±°ë‚˜ ê°€ìš© ì˜ì—­ì— ë¬¸ì œê°€ ìƒê¸°ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”? ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ ì„œë¹„ìŠ¤ ì „ì²´ê°€ ì¢…ë£Œ ë  ê²ë‹ˆë‹¤.

ë§Œì•½ì— A, B, C ê°€ìš© ì˜ì—­ì— í´ëŸ¬ìŠ¤í„°ë¥¼ ë°°ì¹˜ ì‹œì¼°ë‹¤ë©´? íŠ¹ì • í´ëŸ¬ìŠ¤í„°ê°€ ì£½ìœ¼ë©´ ë‚˜ë¨¸ì§€ B, C í´ëŸ¬ìŠ¤í„°ê°€ ëŒì•„ê°€ê³  A í´ëŸ¬ìŠ¤í„°ëŠ” ì¬ ì‹œì‘í•˜ë©´ ê·¸ë§Œì…ë‹ˆë‹¤. í´ëŸ¬ìŠ¤í„°ë¥¼ ì´ìš©í•œ ê³ ê°€ìš©ì„± í™•ë³´ ì´ë¡ ì€ [Set up a cluster for high availability](https://www.elastic.co/guide/en/elasticsearch/reference/current/high-availability.html) ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.

**ë‘˜ì§¸ë¡œ** ë¡¤ë§ ì—…ê·¸ë ˆì´ë“œ(Rolling upgrade)ë¥¼ í†µí•œ ë¬´ì¤‘ë‹¨ ë²„ì „ ì—…ê·¸ë ˆì´ë“œë¥¼ ê°€ëŠ¥ì¼€í•©ë‹ˆë‹¤. ë§Œì•½ ì‹±ê¸€ ë…¸ë“œë¡œ ëŒê³  ìˆë‹¤ë©´ ë²„ì „ ì—…ê·¸ë ˆì´ë“œë¥¼ ìœ„í•´ ì¬ ì‹œì‘ í•˜ëŠ” ë™ì•ˆ ë‹¤ìš´ íƒ€ì„ì´ ìƒê¸°ê²Œ ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ í´ëŸ¬ìŠ¤í„° í™˜ê²½ì—ì„  A, B, C ë…¸ë“œë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì¬ ì‹œì‘í•˜ê¸° ë•Œë¬¸ì— ë‹¤ìš´ íƒ€ì„ ì—†ì´ ë²„ì „ ì—…ê·¸ë ˆì´ë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

**ì…‹ì§¸ë¡œ** í™•ì¥ì— ìš©ì´í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ê°€ ì„±ì¥í•´ ë¡œê·¸ì˜ ì–‘ì´ ëŠ˜ì–´ë‚˜ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œìš”? ë§Œì•½ ì‹±ê¸€ ë…¸ë“œë¡œ ìš´ì˜í•œë‹¤ë©´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì ì‹œ ì¤‘ë‹¨í•œ ë’¤ ìˆ˜ì§ì  í™•ì¥ì„ ê³ ë ¤ í•´ì•¼ í•  ê²ë‹ˆë‹¤. í•˜ì§€ë§Œ í´ëŸ¬ìŠ¤í„°ë¥¼ ìš´ì˜í•˜ê³  ìˆë‹¤ë©´ ì–´ë– í•œ ë‹¤ìš´ íƒ€ì„ ì—†ì´ ìƒˆë¡œìš´ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•˜ê³  ì´ë¥¼ í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ì— í• ë‹¹ í•´ì£¼ë©´ ê·¸ë§Œì…ë‹ˆë‹¤. (ìˆ˜í‰ì  í™•ì¥)

[í”„ë¡œì íŠ¸ ë°”ë¡œê°€ê¸°](https://github.com/dangen-effy/elasticsearch-cluster-docker-compose): [https://github.com/dangen-effy/elasticsearch-cluster-docker-compose](https://github.com/dangen-effy/elasticsearch-cluster-docker-compose)

## í´ëŸ¬ìŠ¤í„° ì§ì ‘ êµ¬ì¶•í•˜ê¸°

í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•˜ëŠ” ë°©ë²•ì€ ë‘ ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤.

* Ansible, AWS CloudFormation í˜¹ì€ Helm ì„ ì´ìš©í•´ì„œ ë¹„êµì  ì‰½ê²Œ êµ¬ì¶•í•˜ê¸°

* Docker Compose í˜¹ì€ ë°”ì´ë„ˆë¦¬ íŒŒì¼ë¡œ ì§ì ‘ êµ¬ì¶•í•˜ê¸° (ì¡°ê¸ˆ ë…¸ê°€ë‹¤)

ì €ëŠ” í›„ìë¥¼ ì„ íƒ í–ˆìŠµë‹ˆë‹¤. ì „ìëŠ” í•œ ë‹¨ê³„ ë” ì¶”ìƒí™” ë¼ìˆê¸° ë•Œë¬¸ì— ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ í´ëŸ¬ìŠ¤í„°ë¥¼ ì§ì ‘ ì˜¬ë ¤ë³¸ ê²½í—˜ ì—†ì´ ì§„í–‰í•˜ë‹¤ë³´ë©´ ë¬¸ì œê°€ ìƒê²¼ì„ë•Œ ë‚´ê°€ ì–´ëŠ êµ¬ê°„ì—ì„œ ì‚½ì§ˆí•˜ê³  ìˆëŠ”ì§€ ë””ë²„ê¹…í•˜ê¸° í˜ë“¤ê²ƒ ê°™ì•˜ìŠµë‹ˆë‹¤. ë°˜ë©´ì— Docker Compose í˜¹ì€ ë°”ì´ë„ˆë¦¬ë¡œ í•œë•€ í•œë•€ ì˜µì…˜ì„ ë„£ì–´ê°€ë©° ì¸ìŠ¤í„´ìŠ¤ì— í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•˜ë©´ ì–´ë–¤ ì˜µì…˜ì´ ì¤‘ìš”í•˜ê³  í•„ìˆ˜ í•„ë“œì¸ì§€, ì–´ë–¤ ì›ë¦¬ë¡œ ëŒì•„ê°€ëŠ”ì§€ íŒŒì•… í•  ìˆ˜ ìˆê±°ë“ ìš”.

í•˜ì§€ë§Œ ì•ìœ¼ë¡œ í•œ ë²ˆ ë” êµ¬ì¶•í•˜ë ¤ê³  í•˜ë©´ Helm ì“°ë ¤ê³ ìš”.

## 1. ë‹¤ì¤‘ ê°€ìš©ì˜ì—­ í™•ë³´í•˜ê¸°

ë¨¼ì € 3 ê°€ì§€ ì´ìƒì˜ ê°ê¸° ë‹¤ë¥¸ ê°€ìš©ì˜ì—­ì— ì¸ìŠ¤í„´ìŠ¤ ìì›ì„ í™•ë³´í•´ì£¼ì„¸ìš”.

## 2. í´ëŸ¬ìŠ¤í„° êµ¬ì¶•í•˜ê¸°

ì´ì œ docker-compose.yml íŒŒì¼ì„ ì‘ì„± í•´ë´…ì‹œë‹¤. ìš°ë¦¬ê°€ ë„ìš¸ ì„œë¹„ìŠ¤ëŠ”

* Elastic Node* 3

* Nginx * 3

* Kibana * 1

ì…ë‹ˆë‹¤. Nginx ëŠ” ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ë¡œ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ(80 => 9200)ë¥¼ ë‹´ë‹¹í•˜ê³  VPC ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ í•©ì‹œë‹¤.

![í´ëŸ¬ìŠ¤í„° í† í´ë¡œì§€](https://cdn-images-1.medium.com/max/2364/1*BFwVg40h_cd7k6pN5xh2Gg.png)*í´ëŸ¬ìŠ¤í„° í† í´ë¡œì§€*

## ë„ì»¤ ì»´í¬ì¦ˆ ì „ì²´ ë³´ê¸°

    version: '2.1'
    services:
      elastic01:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.5.1
        container_name: es01
        environment:
          - node.name=es01-node
          - cluster.name=es-docker-cluster
          - cluster.initial_master_nodes=es03-node,es01-node,es02-node
          - discovery.seed_hosts=es01.example.com:9300,es02.example.com:9300,es03.example.com:9300
          - bootstrap.memory_lock=true
          - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
          - network.host=0.0.0.0
          - node.master=true
          - node.data=true
          - discovery.zen.minimum_master_nodes=1
          - http.port=9200
          - transport.tcp.port=9300
          - network.publish_host=${INTERNAL_HOST}
          - xpack.security.enabled=true
          - ELASTIC_PASSWORD=my_password
          - path.repo=/usr/share/elasticsearch/backup
        
        ulimits:
          memlock:
            soft: -1
            hard: -1
        volumes:
          - data01:/usr/share/elasticsearch/data
          - backup:/usr/share/elasticsearch/backup
        extra_hosts:
          - "es01.example.com:172.26.2.66"
          - "es02.example.com:172.26.4.100"
          - "es03.example.com:172.31.6.133"
        ports:
          - 9300:9300
        networks:
          - elastic
        restart: always
    â€‹
      elastic02:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.5.1
        container_name: es02
        environment:
          - node.name=es02-node
          - cluster.name=es-docker-cluster
          - cluster.initial_master_nodes=es03-node,es01-node,es02-node
          - discovery.seed_hosts=es01.example.com:9300,es02.example.com:9300,es03.example.com:9300
          - bootstrap.memory_lock=true
          - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
          - network.host=0.0.0.0
          - node.master=true
          - node.data=true
          - discovery.zen.minimum_master_nodes=1
          - http.port=9200
          - transport.tcp.port=9300
          - network.publish_host=${INTERNAL_HOST}
          - xpack.security.enabled=true
          - ELASTIC_PASSWORD=my_password
          - path.repo=/usr/share/elasticsearch/backup
        
        ulimits:
          memlock:
            soft: -1
            hard: -1
        volumes:
          - data02:/usr/share/elasticsearch/data
          - backup:/usr/share/elasticsearch/backup
        extra_hosts:
          - "es01.example.com:172.26.2.66"
          - "es02.example.com:172.26.4.100"
          - "es03.example.com:172.31.6.133"
        ports:
          - 9300:9300
        networks:
          - elastic
        restart: always
    â€‹
      elastic03:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.5.1
        container_name: es03
        environment:
          - node.name=es03-node
          - cluster.name=es-docker-cluster
          - cluster.initial_master_nodes=es03-node,es01-node,es02-node
          - discovery.seed_hosts=es01.example.com:9300,es02.example.com:9300,es03.example.com:9300
          - bootstrap.memory_lock=true
          - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
          - network.host=0.0.0.0
          - node.master=true
          - node.data=true
          - discovery.zen.minimum_master_nodes=1
          - http.port=9200
          - transport.tcp.port=9300
          - network.publish_host=${INTERNAL_HOST}
          - xpack.security.enabled=true
          - ELASTIC_PASSWORD=my_password
          - path.repo=/usr/share/elasticsearch/backup
    â€‹
        ulimits:
          memlock:
            soft: -1
            hard: -1
        volumes:
          - data03:/usr/share/elasticsearch/data
          - backup:/usr/share/elasticsearch/backup
        extra_hosts:
          - "es01.example.com:172.26.2.66"
          - "es02.example.com:172.26.4.100"
          - "es03.example.com:172.31.6.133"
        ports:
          - 9300:9300
        networks:
          - elastic
        restart: always
        
      kibana:
        image: docker.elastic.co/kibana/kibana:7.5.1
        container_name: kibana7
        volumes:
          - ./kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml
        ports:
          - 5601:5601
        restart: always
    â€‹
      elasticsearch-node1-proxy:
        image: nginx:latest
        container_name: elasticsearch-proxy-nginx
        ports:
          - 80:80
        volumes:
          - ./proxy/elasticsearch-node1-nginx.conf:/etc/nginx/nginx.conf
        networks:
          - elastic
    â€‹
      elasticsearch-node2-proxy:
        image: nginx:latest
        container_name: elasticsearch-proxy-nginx
        ports:
          - 80:80
        volumes:
          - ./proxy/elasticsearch-node2-nginx.conf:/etc/nginx/nginx.conf
        networks:
          - elastic
          
      elasticsearch-node3-proxy:
        image: nginx:latest
        container_name: elasticsearch-proxy-nginx
        ports:
          - 80:80
        volumes:
          - ./proxy/elasticsearch-node3-nginx.conf:/etc/nginx/nginx.conf
        networks:
          - elastic
    â€‹
    volumes:
      data01:
        driver: local
      data02:
        driver: local
      data03:
        driver: local
      backup:
        driver: local
    â€‹
    networks:
      elastic:
        driver: bridge

* node.name: ë…¸ë“œì— í• ë‹¹ í•˜ëŠ” ê³ ìœ í•œ ì´ë¦„ì…ë‹ˆë‹¤. cluster.initial_master_nodes ì˜µì…˜ì—ì„œ ì´ í•„ë“œë¥¼ ì°¸ì¡°í•˜ë¯€ë¡œ ì˜ ë¶€ì—¬í•´ì£¼ì„¸ìš”.

* cluster.name: í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ì— ë¶™ì—¬ì§€ëŠ” ì´ë¦„ì…ë‹ˆë‹¤. ê°™ì€ í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ìœ¼ë¡œ ì—˜ë¼ìŠ¤í‹± ë…¸ë“œê°€ ë¬¶ì´ê¸° ìœ„í•´ì„œëŠ” ë™ì¼í•œ ì´ë¦„ì„ ê³µìœ  í•´ì•¼í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ëª¨ë“  ë…¸ë“œì— es-docker-cluster ë¼ëŠ” ê°’ì„ í• ë‹¹ í•´ì¤¬ìŠµë‹ˆë‹¤.

* cluster.initial_master_nodes: í´ëŸ¬ìŠ¤í„°ë¥¼ ê°€ë™ì‹œí‚¤ë©´ "ë¶€íŠ¸ìŠ¤íŠ¸ë˜í•‘" ë‹¨ê³„ë¥¼ ê±°ì¹©ë‹ˆë‹¤. ì´ ë‹¨ê³„ì—ì„œ ë§ˆìŠ¤í„° ë…¸ë“œë¡œ íˆ¬í‘œ ê°€ëŠ¥í•œ í›„ë³´ê°€ ëˆ„ê°€ ìˆëŠ”ì§€ ê²°ì •í•˜ëŠ”ë° ì´ ê°’ì„ ì°¸ì¡°í•©ë‹ˆë‹¤.

* discovery.seed_hosts: ë…¸ë“œê°„ ë””ìŠ¤ì»¤ë²„ë¦¬ ë‹¨ê³„ì—ì„œ ì°¸ì¡° ê°€ëŠ¥ í•œ í˜¸ìŠ¤íŠ¸ì˜ ì‹œë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤. [ë”ë³´ê¸°](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-settings.html)

* "ES_JAVA_OPTS=-Xms4g -Xmx4g": JVMì´ ì‚¬ìš© ê°€ëŠ¥í•œ í™ ì‚¬ì´ì¦ˆë¥¼ ê²°ì •í•©ë‹ˆë‹¤. ë©”ëª¨ë¦¬ ìŠ¤í™ì— ë”°ë¼ ë‹¤ë¥¸ ê°’ì„ ê°€ì§‘ë‹ˆë‹¤. [ë”ë³´ê¸°](https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html)

* node.master node.data: í•´ë‹¹ ë…¸ë“œê°€ ë§¡ì„ ìˆ˜ ìˆëŠ” ì—­í• ì„ ì§€ì •í•©ë‹ˆë‹¤. ì´ í¬ìŠ¤íŒ…ì€ master ë…¸ë“œì™€ data ë…¸ë“œë§Œ ì‚¬ìš©í•˜ê³  ìˆì§€ë§Œ, ì—˜ë¼ìŠ¤í‹± í´ëŸ¬ìŠ¤í„°ëŠ” ì—­í• ì— ë”°ë¼ ë…¸ë“œë¥¼ ì„¸ë¶„í™” í•´ì„œ êµ¬ì¶• ê°€ëŠ¥í•©ë‹ˆë‹¤. [ë”ë³´ê¸°](https://www.elastic.co/guide/en/elasticsearch/reference/7.5/modules-node.html)

* network.publish_host: ë…¸ë“œ <=> ë…¸ë“œ ê°„ í†µì‹ ì„(9300 í¬íŠ¸) í•˜ê¸° ìœ„í•´ í¼ë¸”ë¦¬ì‹± í•  í˜¸ìŠ¤íŠ¸ ì£¼ì†Œë¥¼ í• ë‹¹í•©ë‹ˆë‹¤. ë…¸ë“œ ê°„ í†µì‹ ì€ VPC ì™¸ë¶€ì—ì„œ ì°¸ì¡° í•  ì¼ì´ ì—†ìœ¼ë¯€ë¡œ ì¸ìŠ¤í„´ìŠ¤ì˜ ë‚´ë¶€ IP ë¡œ í• ë‹¹ í•˜ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤. ${INTERNAL_HOST} ë¥¼ ì ì ˆíˆ êµì²´ í•´ì£¼ì„¸ìš”.

* path.repo: ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ëŠ” repository ë¼ëŠ” ë°±ì—… ì €ì¥ì†Œ ê°œë…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. API í˜¸ì¶œë¡œ repositoryì— ìŠ¤ëƒ…ìƒ·ì„ ë””ìŠ¤í¬ì— ì €ì¥í•˜ê±°ë‚˜ í´ë¼ìš°ë“œ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•˜ê³  ë³µì› í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. [ë”ë³´ê¸°](https://www.elastic.co/guide/en/elasticsearch/plugins/current/repository.html)

ì´ì œ ë„ì»¤ ì»´í¬ì¦ˆ ì˜µì…˜ì„ ì‚´í´ë´…ì‹œë‹¤.

## Elastic ë„ì»¤ ì»´í¬ì¦ˆ ì‚´í´ë³´ê¸°

### volume

ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Stateful ì• í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤. ì»¨í…Œì´ë„ˆì˜ ìˆ˜ëª…ì´ ë‹¤í•´ë„ ë°ì´í„°ë¥¼ ë‚¨ê¸°ê¸° ìœ„í•´ Named Volume íƒ€ì…ìœ¼ë¡œ ë³¼ë¥¨ì„ ì •ì˜í•´ì¤ì‹œë‹¤. ì´ì œ 1ë²ˆ ë…¸ë“œì˜ ë°ì´í„°ëŠ” ë„ì»¤ì˜ data01 ë³¼ë¥¨ì— ìŒ“ì´ê²Œë©ë‹ˆë‹¤. ë˜í•œ ìŠ¤ëƒ…ìƒ·ì„ ë‚¨ê¸°ê¸° ìœ„í•´ path.repo ì˜µì…˜ì—ì„œ ê°€ë¦¬í‚¤ê³  ìˆëŠ” /usr/share/elasticsearch/backup í´ë”ë„ Named Volume ìœ¼ë¡œ ì§€ì •í•©ë‹ˆë‹¤.

    volumes:
          - data01:/usr/share/elasticsearch/data
          - backup:/usr/share/elasticsearch/backup
    volumes:
          - data02:/usr/share/elasticsearch/data
          - backup:/usr/share/elasticsearch/backup
    volumes:
          - data03:/usr/share/elasticsearch/data
          - backup:/usr/share/elasticsearch/backup
          
    [...]

    volumes:
      data01:
        driver: local
      data02:
        driver: local
      data03:
        driver: local
      backup:
        driver: local

### extra_hosts

ë…¸ë“œ ê°„ ë””ìŠ¤ì»¤ë²„ë¦¬ë¥¼ ìœ„í•´ í˜¸ìŠ¤íŠ¸ë¥¼ ë“±ë¡í•´ì¤ë‹ˆë‹¤. ë•ë¶„ì— discovery.seed_hosts í•„ë“œì—ì„œ es01.example.com ë¥¼ ë‚´ë¶€ ì•„ì´í”¼ë¡œì¨ ì°¸ì¡° í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    extra_hosts:
          - "es01.example.com:172.26.2.66"
          - "es02.example.com:172.26.4.100"
          - "es03.example.com:172.31.6.133"

### networks

ì—˜ë¼ìŠ¤í‹± í´ëŸ¬ìŠ¤í„°ì™€ Nginx ì˜ ì»¨í…Œì´ë„ˆê°„ ë„¤íŠ¸ì›Œí¬ë¥¼ ê°œë°©í•´ì•¼ í•˜ë¯€ë¡œ Bridge ë„¤íŠ¸ì›Œí¬ë¡œ ë¬¶ì–´ì¤ë‹ˆë‹¤.

    networks:
          - elastic
          
    [...]

    networks:
      elastic:
        driver: bridge

## Nginx ë„ì»¤ ì»´í¬ì¦ˆ ì‚´í´ë³´ê¸°

### volumes

Nginx ì½˜í”½ì„ ë„£ì–´ì¤˜ì•¼ í•˜ë¯€ë¡œ Bind Mount ë¥¼ í•´ì¤ì‹œë‹¤.

    volumes:
          - ./proxy/elasticsearch-node1-nginx.conf:/etc/nginx/nginx.conf

### Nginx ì½˜í”½

ì—˜ë¼ìŠ¤í‹±ì„œì¹˜ëŠ” ì™¸ë¶€ IP ì ‘ê·¼ì„ í—ˆìš© í•  í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ server_name ì„ ${INTERNAL_HOST} ë¡œ ì œí•œí•´ì¤ì‹œë‹¤. elasticsearch-node2-nginx.conf, elasticsearch-node3-nginx.conf ë„ ê°’ì„ ë³€ê²½í•´ì£¼ì„¸ìš”.

    user  nginx;
    worker_processes  1;
    error_log  /var/log/nginx/error.log warn;
    pid        /var/run/nginx.pid;
    events {                     
        worker_connections  1024;
    }

    http {

    upstream elasticsearch-container-host {
           server elastic01:9200;
        }

    server {
            listen 80;

    server_name ${INTERNAL_HOST}; # ë‚´ë¶€ ì•„ì´í”¼ë¡œë§Œ ì ‘ê·¼ì‹œ ìš”ì²­ í—ˆìš©

    location / {
                proxy_pass [http://elasticsearch-container-host](http://elasticsearch-container-host);

    proxy_read_timeout 90000;
                proxy_http_version 1.1;
                proxy_set_header X-Forwarded-Host $host;
                proxy_set_header Upgrade $http_upgrade;
            }
        }

    sendfile        on;                                                                
        keepalive_timeout  65;                                                                      
        include /etc/nginx/conf.d/*.conf;           
    }

## Kibana ë„ì»¤ ì»´í¬ì¦ˆ ì‚´í´ë³´ê¸°

### volumes

í‚¤ë°”ë‚˜ë„ ì½˜í”½ íŒŒì¼ì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— Bind Mount ì‹œì¼œì¤ì‹œë‹¤.

    volumes:
          - ./kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml

### kibana.yml

    server.name: kibana
    server.port: 5601
    server.host: "0.0.0.0"
    elasticsearch.username: elastic
    elasticsearch.password: my_password

    # Elasticsearch Nginx ê°€ 80 -> 9200 í”„ë¡ì‹±ì„ í•˜ê¸°ë•Œë¬¸ì— í¬íŠ¸ ì—†ì´ ì”€
    elasticsearch.hosts: [ "[http://172.26.2.66](http://172.26.2.66)", "172.26.4.100", "172.31.6.133" ]

    xpack.security.enabled: true

    server.cors: true
    server.cors.origin: ['*']

ì´ì œ ëª¨ë“  ì„¸íŒ…ì€ ëë‚¬ìŠµë‹ˆë‹¤. í•œ ë²ˆ ì •ë¦¬í•´ë³¼ê¹Œìš”?

    $ tree .
    â”œâ”€â”€ docker-compose.yml
    â”œâ”€â”€ kibana
    â”‚   â””â”€â”€ config
    â”‚       â””â”€â”€ kibana.yml
    â””â”€â”€ proxy
        â”œâ”€â”€ elasticsearch-node1-nginx.conf
        â”œâ”€â”€ elasticsearch-node2-nginx.conf
        â””â”€â”€ elasticsearch-node3-nginx.conf

## í˜„ êµ¬ì¡°ì˜ í•œê³„ì 

í´ëŸ¬ìŠ¤í„°ì˜ í•µì‹¬ì€ ìˆ˜í‰ì  í™•ì¥ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ì§€ê¸ˆì€ ì¸ìŠ¤í„´ìŠ¤ì˜ ìƒíƒœì— ë”°ë¼ ì½˜í”½ íŒŒì¼ì— ê°’ì„ ì§ì ‘ í•˜ë“œì½”ë”© í–ˆê¸° ë•Œë¬¸ì— ìë™í™”ëœ ìˆ˜í‰ì  í™•ì¥ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.

ê°€ë ¹ ë“¤ì–´ì˜¤ëŠ” ë¡œê·¸ëŸ‰ì´ ì¦ê°€ í–ˆì„ë•Œ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ë¥¼ í•œ ëŒ€ ë„ìš°ê³  í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ì— ìƒˆ ë…¸ë“œë¥¼ í• ë‹¹ í•˜ë ¤ë©´ ì–´ë–¤ ì‘ì—…ì„ í•´ì•¼ í• ê¹Œìš”? ìƒˆë¡­ê²Œ ë„ìš´ ì¸ìŠ¤í„´ìŠ¤ì˜ ë‚´ë¶€ ì•„ì´í”¼ì™€ ë…¸ë“œì˜ ì´ë¦„ì„ ì•Œì•„ì•¼ í•˜ë¯€ë¡œ cluster.initial_master_nodes ì™€ discovery.seed_hosts ì— ìƒˆ ë…¸ë“œì˜ ì •ë³´ë¥¼ ì¶”ê°€í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ í‚¤ë°”ë‚˜ ì½˜í”½ì˜ elasticsearch.hosts í•„ë“œë„ ìˆ˜ì •í•´ì¤˜ì•¼ê² ì£ .

ì¦‰ ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ë¥¼ ì‚¬ëŒì´ ì† ìˆ˜ í•´ì¤˜ì•¼ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŠ” ë³´í†µ ê·€ì°®ì€ ì‘ì—…ì´ ì•„ë‹ë¿ë”ëŸ¬ ì‹¤ìˆ˜ë¥¼ ìœ ë°œí•˜ê² ì£ . ì´ë¥¼ í•´ê²°í•˜ë ¤ë©´ ì„œë¹„ìŠ¤ ë“±ë¡ì— ììœ ë¡œìš´ Kubernetes ê°™ì€ ì»¨í…Œì´ë„ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ íˆ´ì„ ì‚¬ìš©í•´ì•¼í•©ë‹ˆë‹¤.
