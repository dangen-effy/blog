---
title: "ÏóòÎùºÏä§Ìã±ÏÑúÏπò ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏßÅÏ†ë Íµ¨ÏÑ±ÌïòÍ∏∞ - Î°úÍ∑∏Í∞Ä Ïû¨ÏÇ∞Ïù¥Îã§"
description: "ÎèÑÏª§ Ïª¥Ìè¨Ï¶àÎ°ú ÏóòÎùºÏä§Ìã± ÏÑúÏπò ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º ÎùÑÏõåÎ¥ÖÏãúÎã§"
tags: ["DevOps", "Docker", "Docker Compose", "docker-compose", "log"]
categories: ["DevOps", "Elastic", "Elasticsearch"]
date: 2020-02-23T15:27:02+09:00
draft: false
---

Î¶¨Î™®Ìä∏Î™¨Ïä§ÌÑ∞Îäî Îã§ÏñëÌïú ÌòïÌÉúÏùò Î°úÍ∑∏Î•º ÏàòÏßëÌï¥ Ï†êÏàòÎ•º Îß§Í≤® ÌÜµÌôî/Î∞©ÏÜ°Ïùò ÌíàÏßàÏùÑ Ï∏°Ï†ïÌï©ÎãàÎã§. üìà

ÏòàÎ•º Îì§Ïñ¥, Ïñ¥Îäê Íµ¨Í∞ÑÏóêÏÑú Ìå®ÌÇ∑ ÏÜêÏã§Ïù¥ ÎßéÏù¥ ÏùºÏñ¥ÎÇòÎäîÏßÄ ÌòπÏùÄ Ïñ¥Îñ§ ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌô©ÏóêÏÑú Ïã§Ìå®Ïú®Ïù¥ ÎÜíÏùÄÏßÄ Îì± Îã§ÏñëÌïú ÏßÄÌëúÎ•º Î™®Îç∏ÎßÅÌïòÍ≥† Í∞úÏÑ† Ï†êÏùÑ ÎèÑÏ∂úÌï©ÎãàÎã§. Ï¶â Î°úÍ∑∏Ïùò ÏÜêÏã§ÏùÄ Ï†ÄÌù¨Ïùò ÎπÑÏ¶àÎãàÏä§ Ïù∏ÏÇ¨Ïù¥Ìä∏Ïùò ÏÜêÏã§Ïóê ÏßÅÍ≤∞Îê©ÎãàÎã§. ÎïåÎ¨∏Ïóê Ïñ¥ÎñªÍ≤åÎì† ÏóòÎùºÏä§Ìã±ÏÑúÏπò Í∞ôÏùÄ Î°úÍ∑∏ Ï†ÄÏû•ÏÜåÏùò ÏïàÏ†ïÏÑ±ÏùÑ ÌôïÎ≥¥ ÌïòÎäîÎç∞ Î™©Ïà®ÏùÑ Í±∏Ïñ¥Ïïº Ìï©ÎãàÎã§. ÏÑúÎπÑÏä§Í∞Ä ÏïàÏ†ïÏ†ÅÏù∏ ÏÉÅÌÉúÏóêÏÑú ÎÇ®ÎäîÍ±¥ Î°úÍ∑∏ Î∞ñÏóê ÏóÜÍ±∞Îì†Ïöî :)

Ïù¥Ï†úÎ∂ÄÌÑ∞ Ï†úÍ∞Ä Î¶¨Î™®Ìä∏Î™¨Ïä§ÌÑ∞ÏóêÏÑú Ïã±Í∏Ä ÎÖ∏ÎìúÎ°ú Ïö¥ÏòÅÌïòÎçò ÏóòÎùºÏä§Ìã±ÏÑúÏπòÎ•º Î©ÄÌã∞ ÌÅ¥Îü¨Ïä§ÌÑ∞ ÌòïÌÉúÎ°ú Ï†ÑÌôòÏãúÌÇ® Í≤ΩÌóòÏùÑ ÌÜ†ÎåÄÎ°ú ÌÅ¥Îü¨Ïä§ÌÑ∞ Íµ¨Ï∂ï Î∞©Î≤ïÏùÑ Í∞ÑÎûµÌûà ÌíÄÏñ¥ ÎÇòÍ∞ÄÎ†§Í≥† Ìï©ÎãàÎã§.

ÏõêÎ°†Ï†ÅÏù∏ ÏßàÎ¨∏Î∂ÄÌÑ∞ ÏãúÏûëÌïòÎ©¥ ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º Íµ¨ÏÑ±ÌïòÎäî Ïù¥Ïú†Îäî Î≠ò ÍπåÏöî? Ïã±Í∏Ä ÎÖ∏ÎìúÎ°ú Ïûò ÎèåÏïÑÍ∞ÄÎçò ÏóòÎùºÏä§Ìã±ÏÑúÏπòÎ•º Íµ≥Ïù¥ Î©ÄÌã∞ ÌÅ¥Îü¨Ïä§ÌÑ∞Î°ú ÏóÖÍ∑∏Î†àÏù¥Îìú ÏãúÌÇ® Ïù¥Ïú†Í∞Ä Î≠ò ÍπåÏöî?

**Ï≤´Ïß∏Î°ú** Îã§Ï§ë Í∞ÄÏö©ÏòÅÏó≠Ïóê ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º Íµ¨Ï∂ïÏãúÏºú Í∞ÄÏö©ÏÑ±ÏùÑ Ìñ•ÏÉÅ ÏãúÌÇ¨ Ïàò ÏûàÏäµÎãàÎã§. ÎßåÏïΩ Ïã±Í∏Ä ÎÖ∏ÎìúÎ°ú ÎèåÏïÑÍ∞ÄÎçò ÏóòÎùºÏä§Ìã±ÏÑúÏπòÍ∞Ä Ï¢ÖÎ£åÎêòÍ±∞ÎÇò Í∞ÄÏö© ÏòÅÏó≠Ïóê Î¨∏Ï†úÍ∞Ä ÏÉùÍ∏∞Î©¥ Ïñ¥ÎñªÍ≤å Îê†ÍπåÏöî? ÏóòÎùºÏä§Ìã±ÏÑúÏπò ÏÑúÎπÑÏä§ Ï†ÑÏ≤¥Í∞Ä Ï¢ÖÎ£å Îê† Í≤ÅÎãàÎã§.

ÎßåÏïΩÏóê A, B, C Í∞ÄÏö© ÏòÅÏó≠Ïóê ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º Î∞∞Ïπò ÏãúÏº∞Îã§Î©¥? ÌäπÏ†ï ÌÅ¥Îü¨Ïä§ÌÑ∞Í∞Ä Ï£ΩÏúºÎ©¥ ÎÇòÎ®∏ÏßÄ B, C ÌÅ¥Îü¨Ïä§ÌÑ∞Í∞Ä ÎèåÏïÑÍ∞ÄÍ≥† A ÌÅ¥Îü¨Ïä§ÌÑ∞Îäî Ïû¨ ÏãúÏûëÌïòÎ©¥ Í∑∏ÎßåÏûÖÎãàÎã§. ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º Ïù¥Ïö©Ìïú Í≥†Í∞ÄÏö©ÏÑ± ÌôïÎ≥¥ Ïù¥Î°†ÏùÄ [Set up a cluster for high availability](https://www.elastic.co/guide/en/elasticsearch/reference/current/high-availability.html) ÏóêÏÑú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.

**ÎëòÏß∏Î°ú** Î°§ÎßÅ ÏóÖÍ∑∏Î†àÏù¥Îìú(Rolling upgrade)Î•º ÌÜµÌïú Î¨¥Ï§ëÎã® Î≤ÑÏ†Ñ ÏóÖÍ∑∏Î†àÏù¥ÎìúÎ•º Í∞ÄÎä•ÏºÄÌï©ÎãàÎã§. ÎßåÏïΩ Ïã±Í∏Ä ÎÖ∏ÎìúÎ°ú ÎèåÍ≥† ÏûàÎã§Î©¥ Î≤ÑÏ†Ñ ÏóÖÍ∑∏Î†àÏù¥ÎìúÎ•º ÏúÑÌï¥ Ïû¨ ÏãúÏûë ÌïòÎäî ÎèôÏïà Îã§Ïö¥ ÌÉÄÏûÑÏù¥ ÏÉùÍ∏∞Í≤å Îê©ÎãàÎã§. Í∑∏Îü¨ÎÇò ÌÅ¥Îü¨Ïä§ÌÑ∞ ÌôòÍ≤ΩÏóêÏÑ† A, B, C ÎÖ∏ÎìúÎ•º ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ïû¨ ÏãúÏûëÌïòÍ∏∞ ÎïåÎ¨∏Ïóê Îã§Ïö¥ ÌÉÄÏûÑ ÏóÜÏù¥ Î≤ÑÏ†Ñ ÏóÖÍ∑∏Î†àÏù¥ÎìúÍ∞Ä Í∞ÄÎä•Ìï©ÎãàÎã§.

**ÏÖãÏß∏Î°ú** ÌôïÏû•Ïóê Ïö©Ïù¥Ìï©ÎãàÎã§. ÏÑúÎπÑÏä§Í∞Ä ÏÑ±Ïû•Ìï¥ Î°úÍ∑∏Ïùò ÏñëÏù¥ ÎäòÏñ¥ÎÇòÎ©¥ Ïñ¥ÎñªÍ≤å Ìï¥ÏïºÌï†ÍπåÏöî? ÎßåÏïΩ Ïã±Í∏Ä ÎÖ∏ÎìúÎ°ú Ïö¥ÏòÅÌïúÎã§Î©¥ Ïù∏Ïä§ÌÑ¥Ïä§Î•º Ïû†Ïãú Ï§ëÎã®Ìïú Îí§ ÏàòÏßÅÏ†Å ÌôïÏû•ÏùÑ Í≥†Î†§ Ìï¥Ïïº Ìï† Í≤ÅÎãàÎã§. ÌïòÏßÄÎßå ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º Ïö¥ÏòÅÌïòÍ≥† ÏûàÎã§Î©¥ Ïñ¥Îñ†Ìïú Îã§Ïö¥ ÌÉÄÏûÑ ÏóÜÏù¥ ÏÉàÎ°úÏö¥ ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º Íµ¨Ï∂ïÌïòÍ≥† Ïù¥Î•º ÌÅ¥Îü¨Ïä§ÌÑ∞ Í∑∏Î£πÏóê Ìï†Îãπ Ìï¥Ï£ºÎ©¥ Í∑∏ÎßåÏûÖÎãàÎã§. (ÏàòÌèâÏ†Å ÌôïÏû•)

[ÌîÑÎ°úÏ†ùÌä∏ Î∞îÎ°úÍ∞ÄÍ∏∞](https://github.com/dangen-effy/elasticsearch-cluster-docker-compose): [https://github.com/dangen-effy/elasticsearch-cluster-docker-compose](https://github.com/dangen-effy/elasticsearch-cluster-docker-compose)

## ÌÅ¥Îü¨Ïä§ÌÑ∞ ÏßÅÏ†ë Íµ¨Ï∂ïÌïòÍ∏∞

ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º Íµ¨Ï∂ïÌïòÎäî Î∞©Î≤ïÏùÄ Îëê Í∞ÄÏßÄÍ∞Ä ÏûàÏäµÎãàÎã§.

* Ansible, AWS CloudFormation ÌòπÏùÄ Helm ÏùÑ Ïù¥Ïö©Ìï¥ÏÑú ÎπÑÍµêÏ†Å ÏâΩÍ≤å Íµ¨Ï∂ïÌïòÍ∏∞

* Docker Compose ÌòπÏùÄ Î∞îÏù¥ÎÑàÎ¶¨ ÌååÏùºÎ°ú ÏßÅÏ†ë Íµ¨Ï∂ïÌïòÍ∏∞ (Ï°∞Í∏à ÎÖ∏Í∞ÄÎã§)

Ï†ÄÎäî ÌõÑÏûêÎ•º ÏÑ†ÌÉù ÌñàÏäµÎãàÎã§. Ï†ÑÏûêÎäî Ìïú Îã®Í≥Ñ Îçî Ï∂îÏÉÅÌôî ÎèºÏûàÍ∏∞ ÎïåÎ¨∏Ïóê ÏóòÎùºÏä§Ìã±ÏÑúÏπò ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º ÏßÅÏ†ë Ïò¨Î†§Î≥∏ Í≤ΩÌóò ÏóÜÏù¥ ÏßÑÌñâÌïòÎã§Î≥¥Î©¥ Î¨∏Ï†úÍ∞Ä ÏÉùÍ≤ºÏùÑÎïå ÎÇ¥Í∞Ä Ïñ¥Îäê Íµ¨Í∞ÑÏóêÏÑú ÏÇΩÏßàÌïòÍ≥† ÏûàÎäîÏßÄ ÎîîÎ≤ÑÍπÖÌïòÍ∏∞ ÌûòÎì§Í≤É Í∞ôÏïòÏäµÎãàÎã§. Î∞òÎ©¥Ïóê Docker Compose ÌòπÏùÄ Î∞îÏù¥ÎÑàÎ¶¨Î°ú ÌïúÎïÄ ÌïúÎïÄ ÏòµÏÖòÏùÑ ÎÑ£Ïñ¥Í∞ÄÎ©∞ Ïù∏Ïä§ÌÑ¥Ïä§Ïóê ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º Íµ¨Ï∂ïÌïòÎ©¥ Ïñ¥Îñ§ ÏòµÏÖòÏù¥ Ï§ëÏöîÌïòÍ≥† ÌïÑÏàò ÌïÑÎìúÏù∏ÏßÄ, Ïñ¥Îñ§ ÏõêÎ¶¨Î°ú ÎèåÏïÑÍ∞ÄÎäîÏßÄ ÌååÏïÖ Ìï† Ïàò ÏûàÍ±∞Îì†Ïöî.

ÌïòÏßÄÎßå ÏïûÏúºÎ°ú Ìïú Î≤à Îçî Íµ¨Ï∂ïÌïòÎ†§Í≥† ÌïòÎ©¥ Helm Ïì∞Î†§Í≥†Ïöî.

## 1. Îã§Ï§ë Í∞ÄÏö©ÏòÅÏó≠ ÌôïÎ≥¥ÌïòÍ∏∞

Î®ºÏ†Ä 3 Í∞ÄÏßÄ Ïù¥ÏÉÅÏùò Í∞ÅÍ∏∞ Îã§Î•∏ Í∞ÄÏö©ÏòÅÏó≠Ïóê Ïù∏Ïä§ÌÑ¥Ïä§ ÏûêÏõêÏùÑ ÌôïÎ≥¥Ìï¥Ï£ºÏÑ∏Ïöî.

## 2. ÌÅ¥Îü¨Ïä§ÌÑ∞ Íµ¨Ï∂ïÌïòÍ∏∞

Ïù¥Ï†ú docker-compose.yml ÌååÏùºÏùÑ ÏûëÏÑ± Ìï¥Î¥ÖÏãúÎã§. Ïö∞Î¶¨Í∞Ä ÎùÑÏö∏ ÏÑúÎπÑÏä§Îäî

* Elastic Node* 3

* Nginx * 3

* Kibana * 1

ÏûÖÎãàÎã§. Nginx Îäî ÏóòÎùºÏä§Ìã±ÏÑúÏπòÎ°ú Î¶¨Î≤ÑÏä§ ÌîÑÎ°ùÏãú(80 => 9200)Î•º Îã¥ÎãπÌïòÍ≥† VPC ÎÇ¥Î∂ÄÏóêÏÑúÎßå Ï†ëÍ∑º Í∞ÄÎä•ÌïòÎèÑÎ°ù Ìï©ÏãúÎã§.

![ÌÅ¥Îü¨Ïä§ÌÑ∞ ÌÜ†Ìè¥Î°úÏßÄ](https://cdn-images-1.medium.com/max/2364/1*BFwVg40h_cd7k6pN5xh2Gg.png)*ÌÅ¥Îü¨Ïä§ÌÑ∞ ÌÜ†Ìè¥Î°úÏßÄ*

## ÎèÑÏª§ Ïª¥Ìè¨Ï¶à Ï†ÑÏ≤¥ Î≥¥Í∏∞

    version: '2.1'
    services:
      elastic01:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.5.1
        container_name: es01
        environment:
          - node.name=es01-node
          - cluster.name=es-docker-cluster
          - cluster.initial_master_nodes=es03-node,es01-node,es02-node
          - discovery.seed_hosts=es01.example.com:9300,es02.example.com:9300,es03.example.com:9300
          - bootstrap.memory_lock=true
          - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
          - network.host=0.0.0.0
          - node.master=true
          - node.data=true
          - discovery.zen.minimum_master_nodes=1
          - http.port=9200
          - transport.tcp.port=9300
          - network.publish_host=${INTERNAL_HOST}
          - xpack.security.enabled=true
          - ELASTIC_PASSWORD=my_password
          - path.repo=/usr/share/elasticsearch/backup
        
        ulimits:
          memlock:
            soft: -1
            hard: -1
        volumes:
          - data01:/usr/share/elasticsearch/data
          - backup:/usr/share/elasticsearch/backup
        extra_hosts:
          - "es01.example.com:172.26.2.66"
          - "es02.example.com:172.26.4.100"
          - "es03.example.com:172.31.6.133"
        ports:
          - 9300:9300
        networks:
          - elastic
        restart: always
    ‚Äã
      elastic02:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.5.1
        container_name: es02
        environment:
          - node.name=es02-node
          - cluster.name=es-docker-cluster
          - cluster.initial_master_nodes=es03-node,es01-node,es02-node
          - discovery.seed_hosts=es01.example.com:9300,es02.example.com:9300,es03.example.com:9300
          - bootstrap.memory_lock=true
          - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
          - network.host=0.0.0.0
          - node.master=true
          - node.data=true
          - discovery.zen.minimum_master_nodes=1
          - http.port=9200
          - transport.tcp.port=9300
          - network.publish_host=${INTERNAL_HOST}
          - xpack.security.enabled=true
          - ELASTIC_PASSWORD=my_password
          - path.repo=/usr/share/elasticsearch/backup
        
        ulimits:
          memlock:
            soft: -1
            hard: -1
        volumes:
          - data02:/usr/share/elasticsearch/data
          - backup:/usr/share/elasticsearch/backup
        extra_hosts:
          - "es01.example.com:172.26.2.66"
          - "es02.example.com:172.26.4.100"
          - "es03.example.com:172.31.6.133"
        ports:
          - 9300:9300
        networks:
          - elastic
        restart: always
    ‚Äã
      elastic03:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.5.1
        container_name: es03
        environment:
          - node.name=es03-node
          - cluster.name=es-docker-cluster
          - cluster.initial_master_nodes=es03-node,es01-node,es02-node
          - discovery.seed_hosts=es01.example.com:9300,es02.example.com:9300,es03.example.com:9300
          - bootstrap.memory_lock=true
          - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
          - network.host=0.0.0.0
          - node.master=true
          - node.data=true
          - discovery.zen.minimum_master_nodes=1
          - http.port=9200
          - transport.tcp.port=9300
          - network.publish_host=${INTERNAL_HOST}
          - xpack.security.enabled=true
          - ELASTIC_PASSWORD=my_password
          - path.repo=/usr/share/elasticsearch/backup
    ‚Äã
        ulimits:
          memlock:
            soft: -1
            hard: -1
        volumes:
          - data03:/usr/share/elasticsearch/data
          - backup:/usr/share/elasticsearch/backup
        extra_hosts:
          - "es01.example.com:172.26.2.66"
          - "es02.example.com:172.26.4.100"
          - "es03.example.com:172.31.6.133"
        ports:
          - 9300:9300
        networks:
          - elastic
        restart: always
        
      kibana:
        image: docker.elastic.co/kibana/kibana:7.5.1
        container_name: kibana7
        volumes:
          - ./kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml
        ports:
          - 5601:5601
        restart: always
    ‚Äã
      elasticsearch-node1-proxy:
        image: nginx:latest
        container_name: elasticsearch-proxy-nginx
        ports:
          - 80:80
        volumes:
          - ./proxy/elasticsearch-node1-nginx.conf:/etc/nginx/nginx.conf
        networks:
          - elastic
    ‚Äã
      elasticsearch-node2-proxy:
        image: nginx:latest
        container_name: elasticsearch-proxy-nginx
        ports:
          - 80:80
        volumes:
          - ./proxy/elasticsearch-node2-nginx.conf:/etc/nginx/nginx.conf
        networks:
          - elastic
          
      elasticsearch-node3-proxy:
        image: nginx:latest
        container_name: elasticsearch-proxy-nginx
        ports:
          - 80:80
        volumes:
          - ./proxy/elasticsearch-node3-nginx.conf:/etc/nginx/nginx.conf
        networks:
          - elastic
    ‚Äã
    volumes:
      data01:
        driver: local
      data02:
        driver: local
      data03:
        driver: local
      backup:
        driver: local
    ‚Äã
    networks:
      elastic:
        driver: bridge

* node.name: ÎÖ∏ÎìúÏóê Ìï†Îãπ ÌïòÎäî Í≥†Ïú†Ìïú Ïù¥Î¶ÑÏûÖÎãàÎã§. cluster.initial_master_nodes ÏòµÏÖòÏóêÏÑú Ïù¥ ÌïÑÎìúÎ•º Ï∞∏Ï°∞ÌïòÎØÄÎ°ú Ïûò Î∂ÄÏó¨Ìï¥Ï£ºÏÑ∏Ïöî.

* cluster.name: ÌÅ¥Îü¨Ïä§ÌÑ∞ Í∑∏Î£πÏóê Î∂ôÏó¨ÏßÄÎäî Ïù¥Î¶ÑÏûÖÎãàÎã§. Í∞ôÏùÄ ÌÅ¥Îü¨Ïä§ÌÑ∞ Í∑∏Î£πÏúºÎ°ú ÏóòÎùºÏä§Ìã± ÎÖ∏ÎìúÍ∞Ä Î¨∂Ïù¥Í∏∞ ÏúÑÌï¥ÏÑúÎäî ÎèôÏùºÌïú Ïù¥Î¶ÑÏùÑ Í≥µÏú† Ìï¥ÏïºÌï©ÎãàÎã§. Îî∞ÎùºÏÑú Î™®Îì† ÎÖ∏ÎìúÏóê es-docker-cluster ÎùºÎäî Í∞íÏùÑ Ìï†Îãπ Ìï¥Ï§¨ÏäµÎãàÎã§.

* cluster.initial_master_nodes: ÌÅ¥Îü¨Ïä§ÌÑ∞Î•º Í∞ÄÎèôÏãúÌÇ§Î©¥ "Î∂ÄÌä∏Ïä§Ìä∏ÎûòÌïë" Îã®Í≥ÑÎ•º Í±∞Ïπ©ÎãàÎã§. Ïù¥ Îã®Í≥ÑÏóêÏÑú ÎßàÏä§ÌÑ∞ ÎÖ∏ÎìúÎ°ú Ìà¨Ìëú Í∞ÄÎä•Ìïú ÌõÑÎ≥¥Í∞Ä ÎàÑÍ∞Ä ÏûàÎäîÏßÄ Í≤∞Ï†ïÌïòÎäîÎç∞ Ïù¥ Í∞íÏùÑ Ï∞∏Ï°∞Ìï©ÎãàÎã§.

* discovery.seed_hosts: ÎÖ∏ÎìúÍ∞Ñ ÎîîÏä§Ïª§Î≤ÑÎ¶¨ Îã®Í≥ÑÏóêÏÑú Ï∞∏Ï°∞ Í∞ÄÎä• Ìïú Ìò∏Ïä§Ìä∏Ïùò ÏãúÎìúÎ•º Ï†úÍ≥µÌï©ÎãàÎã§. [ÎçîÎ≥¥Í∏∞](https://www.elastic.co/guide/en/elasticsearch/reference/current/discovery-settings.html)

* "ES_JAVA_OPTS=-Xms4g -Xmx4g": JVMÏù¥ ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ìûô ÏÇ¨Ïù¥Ï¶àÎ•º Í≤∞Ï†ïÌï©ÎãàÎã§. Î©îÎ™®Î¶¨ Ïä§ÌéôÏóê Îî∞Îùº Îã§Î•∏ Í∞íÏùÑ Í∞ÄÏßëÎãàÎã§. [ÎçîÎ≥¥Í∏∞](https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html)

* node.master node.data: Ìï¥Îãπ ÎÖ∏ÎìúÍ∞Ä Îß°ÏùÑ Ïàò ÏûàÎäî Ïó≠Ìï†ÏùÑ ÏßÄÏ†ïÌï©ÎãàÎã§. Ïù¥ Ìè¨Ïä§ÌåÖÏùÄ master ÎÖ∏ÎìúÏôÄ data ÎÖ∏ÎìúÎßå ÏÇ¨Ïö©ÌïòÍ≥† ÏûàÏßÄÎßå, ÏóòÎùºÏä§Ìã± ÌÅ¥Îü¨Ïä§ÌÑ∞Îäî Ïó≠Ìï†Ïóê Îî∞Îùº ÎÖ∏ÎìúÎ•º ÏÑ∏Î∂ÑÌôî Ìï¥ÏÑú Íµ¨Ï∂ï Í∞ÄÎä•Ìï©ÎãàÎã§. [ÎçîÎ≥¥Í∏∞](https://www.elastic.co/guide/en/elasticsearch/reference/7.5/modules-node.html)

* network.publish_host: ÎÖ∏Îìú <=> ÎÖ∏Îìú Í∞Ñ ÌÜµÏã†ÏùÑ(9300 Ìè¨Ìä∏) ÌïòÍ∏∞ ÏúÑÌï¥ ÌçºÎ∏îÎ¶¨Ïã± Ìï† Ìò∏Ïä§Ìä∏ Ï£ºÏÜåÎ•º Ìï†ÎãπÌï©ÎãàÎã§. ÎÖ∏Îìú Í∞Ñ ÌÜµÏã†ÏùÄ VPC Ïô∏Î∂ÄÏóêÏÑú Ï∞∏Ï°∞ Ìï† ÏùºÏù¥ ÏóÜÏúºÎØÄÎ°ú Ïù∏Ïä§ÌÑ¥Ïä§Ïùò ÎÇ¥Î∂Ä IP Î°ú Ìï†Îãπ ÌïòÎäî Í≤ÉÏùÑ Ï∂îÏ≤úÌï©ÎãàÎã§. ${INTERNAL_HOST} Î•º Ï†ÅÏ†àÌûà ÍµêÏ≤¥ Ìï¥Ï£ºÏÑ∏Ïöî.

* path.repo: ÏóòÎùºÏä§Ìã±ÏÑúÏπòÎäî repository ÎùºÎäî Î∞±ÏóÖ Ï†ÄÏû•ÏÜå Í∞úÎÖêÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§. API Ìò∏Ï∂úÎ°ú repositoryÏóê Ïä§ÎÉÖÏÉ∑ÏùÑ ÎîîÏä§ÌÅ¨Ïóê Ï†ÄÏû•ÌïòÍ±∞ÎÇò ÌÅ¥ÎùºÏö∞Îìú Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•ÌïòÍ≥† Î≥µÏõê Ìï† Ïàò ÏûàÏäµÎãàÎã§. [ÎçîÎ≥¥Í∏∞](https://www.elastic.co/guide/en/elasticsearch/plugins/current/repository.html)

Ïù¥Ï†ú ÎèÑÏª§ Ïª¥Ìè¨Ï¶à ÏòµÏÖòÏùÑ ÏÇ¥Ìé¥Î¥ÖÏãúÎã§.

## Elastic ÎèÑÏª§ Ïª¥Ìè¨Ï¶à ÏÇ¥Ìé¥Î≥¥Í∏∞

### volume

ÏóòÎùºÏä§Ìã±ÏÑúÏπòÎäî Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Stateful Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖòÏûÖÎãàÎã§. Ïª®ÌÖåÏù¥ÎÑàÏùò ÏàòÎ™ÖÏù¥ Îã§Ìï¥ÎèÑ Îç∞Ïù¥ÌÑ∞Î•º ÎÇ®Í∏∞Í∏∞ ÏúÑÌï¥ Named Volume ÌÉÄÏûÖÏúºÎ°ú Î≥ºÎ•®ÏùÑ Ï†ïÏùòÌï¥Ï§çÏãúÎã§. Ïù¥Ï†ú 1Î≤à ÎÖ∏ÎìúÏùò Îç∞Ïù¥ÌÑ∞Îäî ÎèÑÏª§Ïùò data01 Î≥ºÎ•®Ïóê ÏåìÏù¥Í≤åÎê©ÎãàÎã§. ÎòêÌïú Ïä§ÎÉÖÏÉ∑ÏùÑ ÎÇ®Í∏∞Í∏∞ ÏúÑÌï¥ path.repo ÏòµÏÖòÏóêÏÑú Í∞ÄÎ¶¨ÌÇ§Í≥† ÏûàÎäî /usr/share/elasticsearch/backup Ìè¥ÎçîÎèÑ Named Volume ÏúºÎ°ú ÏßÄÏ†ïÌï©ÎãàÎã§.

    volumes:
          - data01:/usr/share/elasticsearch/data
          - backup:/usr/share/elasticsearch/backup
    volumes:
          - data02:/usr/share/elasticsearch/data
          - backup:/usr/share/elasticsearch/backup
    volumes:
          - data03:/usr/share/elasticsearch/data
          - backup:/usr/share/elasticsearch/backup
          
    [...]

    volumes:
      data01:
        driver: local
      data02:
        driver: local
      data03:
        driver: local
      backup:
        driver: local

### extra_hosts

ÎÖ∏Îìú Í∞Ñ ÎîîÏä§Ïª§Î≤ÑÎ¶¨Î•º ÏúÑÌï¥ Ìò∏Ïä§Ìä∏Î•º Îì±Î°ùÌï¥Ï§çÎãàÎã§. ÎçïÎ∂ÑÏóê discovery.seed_hosts ÌïÑÎìúÏóêÏÑú es01.example.com Î•º ÎÇ¥Î∂Ä ÏïÑÏù¥ÌîºÎ°úÏç® Ï∞∏Ï°∞ Ìï† Ïàò ÏûàÏäµÎãàÎã§.

    extra_hosts:
          - "es01.example.com:172.26.2.66"
          - "es02.example.com:172.26.4.100"
          - "es03.example.com:172.31.6.133"

### networks

ÏóòÎùºÏä§Ìã± ÌÅ¥Îü¨Ïä§ÌÑ∞ÏôÄ Nginx Ïùò Ïª®ÌÖåÏù¥ÎÑàÍ∞Ñ ÎÑ§Ìä∏ÏõåÌÅ¨Î•º Í∞úÎ∞©Ìï¥Ïïº ÌïòÎØÄÎ°ú Bridge ÎÑ§Ìä∏ÏõåÌÅ¨Î°ú Î¨∂Ïñ¥Ï§çÎãàÎã§.

    networks:
          - elastic
          
    [...]

    networks:
      elastic:
        driver: bridge

## Nginx ÎèÑÏª§ Ïª¥Ìè¨Ï¶à ÏÇ¥Ìé¥Î≥¥Í∏∞

### volumes

Nginx ÏΩòÌîΩÏùÑ ÎÑ£Ïñ¥Ï§òÏïº ÌïòÎØÄÎ°ú Bind Mount Î•º Ìï¥Ï§çÏãúÎã§.

    volumes:
          - ./proxy/elasticsearch-node1-nginx.conf:/etc/nginx/nginx.conf

### Nginx ÏΩòÌîΩ

ÏóòÎùºÏä§Ìã±ÏÑúÏπòÎäî Ïô∏Î∂Ä IP Ï†ëÍ∑ºÏùÑ ÌóàÏö© Ìï† ÌïÑÏöîÍ∞Ä ÏóÜÏúºÎØÄÎ°ú server_name ÏùÑ ${INTERNAL_HOST} Î°ú Ï†úÌïúÌï¥Ï§çÏãúÎã§. elasticsearch-node2-nginx.conf, elasticsearch-node3-nginx.conf ÎèÑ Í∞íÏùÑ Î≥ÄÍ≤ΩÌï¥Ï£ºÏÑ∏Ïöî.

    user  nginx;
    worker_processes  1;
    error_log  /var/log/nginx/error.log warn;
    pid        /var/run/nginx.pid;
    events {                     
        worker_connections  1024;
    }

    http {

    upstream elasticsearch-container-host {
           server elastic01:9200;
        }

    server {
            listen 80;

    server_name ${INTERNAL_HOST}; # ÎÇ¥Î∂Ä ÏïÑÏù¥ÌîºÎ°úÎßå Ï†ëÍ∑ºÏãú ÏöîÏ≤≠ ÌóàÏö©

    location / {
                proxy_pass [http://elasticsearch-container-host](http://elasticsearch-container-host);

    proxy_read_timeout 90000;
                proxy_http_version 1.1;
                proxy_set_header X-Forwarded-Host $host;
                proxy_set_header Upgrade $http_upgrade;
            }
        }

    sendfile        on;                                                                
        keepalive_timeout  65;                                                                      
        include /etc/nginx/conf.d/*.conf;           
    }

## Kibana ÎèÑÏª§ Ïª¥Ìè¨Ï¶à ÏÇ¥Ìé¥Î≥¥Í∏∞

### volumes

ÌÇ§Î∞îÎÇòÎèÑ ÏΩòÌîΩ ÌååÏùºÏù¥ ÌïÑÏöîÌïòÍ∏∞ ÎïåÎ¨∏Ïóê Bind Mount ÏãúÏºúÏ§çÏãúÎã§.

    volumes:
          - ./kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml

### kibana.yml

    server.name: kibana
    server.port: 5601
    server.host: "0.0.0.0"
    elasticsearch.username: elastic
    elasticsearch.password: my_password

    # Elasticsearch Nginx Í∞Ä 80 -> 9200 ÌîÑÎ°ùÏã±ÏùÑ ÌïòÍ∏∞ÎïåÎ¨∏Ïóê Ìè¨Ìä∏ ÏóÜÏù¥ ÏîÄ
    elasticsearch.hosts: [ "[http://172.26.2.66](http://172.26.2.66)", "172.26.4.100", "172.31.6.133" ]

    xpack.security.enabled: true

    server.cors: true
    server.cors.origin: ['*']

Ïù¥Ï†ú Î™®Îì† ÏÑ∏ÌåÖÏùÄ ÎÅùÎÇ¨ÏäµÎãàÎã§. Ìïú Î≤à Ï†ïÎ¶¨Ìï¥Î≥ºÍπåÏöî?

    $ tree .
    ‚îú‚îÄ‚îÄ docker-compose.yml
    ‚îú‚îÄ‚îÄ kibana
    ‚îÇ   ‚îî‚îÄ‚îÄ config
    ‚îÇ       ‚îî‚îÄ‚îÄ kibana.yml
    ‚îî‚îÄ‚îÄ proxy
        ‚îú‚îÄ‚îÄ elasticsearch-node1-nginx.conf
        ‚îú‚îÄ‚îÄ elasticsearch-node2-nginx.conf
        ‚îî‚îÄ‚îÄ elasticsearch-node3-nginx.conf

## ÌòÑ Íµ¨Ï°∞Ïùò ÌïúÍ≥ÑÏ†ê

ÌÅ¥Îü¨Ïä§ÌÑ∞Ïùò ÌïµÏã¨ÏùÄ ÏàòÌèâÏ†Å ÌôïÏû•ÏûÖÎãàÎã§. ÌïòÏßÄÎßå ÏßÄÍ∏àÏùÄ Ïù∏Ïä§ÌÑ¥Ïä§Ïùò ÏÉÅÌÉúÏóê Îî∞Îùº ÏΩòÌîΩ ÌååÏùºÏóê Í∞íÏùÑ ÏßÅÏ†ë ÌïòÎìúÏΩîÎî© ÌñàÍ∏∞ ÎïåÎ¨∏Ïóê ÏûêÎèôÌôîÎêú ÏàòÌèâÏ†Å ÌôïÏû•ÏùÄ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§.

Í∞ÄÎ†π Îì§Ïñ¥Ïò§Îäî Î°úÍ∑∏ÎüâÏù¥ Ï¶ùÍ∞Ä ÌñàÏùÑÎïå ÏÉà Ïù∏Ïä§ÌÑ¥Ïä§Î•º Ìïú ÎåÄ ÎùÑÏö∞Í≥† ÌÅ¥Îü¨Ïä§ÌÑ∞ Í∑∏Î£πÏóê ÏÉà ÎÖ∏ÎìúÎ•º Ìï†Îãπ ÌïòÎ†§Î©¥ Ïñ¥Îñ§ ÏûëÏóÖÏùÑ Ìï¥Ïïº Ìï†ÍπåÏöî? ÏÉàÎ°≠Í≤å ÎùÑÏö¥ Ïù∏Ïä§ÌÑ¥Ïä§Ïùò ÎÇ¥Î∂Ä ÏïÑÏù¥ÌîºÏôÄ ÎÖ∏ÎìúÏùò Ïù¥Î¶ÑÏùÑ ÏïåÏïÑÏïº ÌïòÎØÄÎ°ú cluster.initial_master_nodes ÏôÄ discovery.seed_hosts Ïóê ÏÉà ÎÖ∏ÎìúÏùò Ï†ïÎ≥¥Î•º Ï∂îÍ∞ÄÌï¥Ï§òÏïº Ìï©ÎãàÎã§. ÎòêÌïú ÌÇ§Î∞îÎÇò ÏΩòÌîΩÏùò elasticsearch.hosts ÌïÑÎìúÎèÑ ÏàòÏ†ïÌï¥Ï§òÏïºÍ≤†Ï£†.

Ï¶â ÏÑúÎπÑÏä§ ÎîîÏä§Ïª§Î≤ÑÎ¶¨Î•º ÏÇ¨ÎûåÏù¥ ÏÜê Ïàò Ìï¥Ï§òÏïº ÌïúÎã§Îäî Í≤ÉÏûÖÎãàÎã§. Ïù¥Îäî Î≥¥ÌÜµ Í∑ÄÏ∞ÆÏùÄ ÏûëÏóÖÏù¥ ÏïÑÎãêÎøêÎçîÎü¨ Ïã§ÏàòÎ•º Ïú†Î∞úÌïòÍ≤†Ï£†. Ïù¥Î•º Ìï¥Í≤∞ÌïòÎ†§Î©¥ ÏÑúÎπÑÏä§ Îì±Î°ùÏóê ÏûêÏú†Î°úÏö¥ Kubernetes Í∞ôÏùÄ Ïª®ÌÖåÏù¥ÎÑà Ïò§ÏºÄÏä§Ìä∏Î†àÏù¥ÏÖò Ìà¥ÏùÑ ÏÇ¨Ïö©Ìï¥ÏïºÌï©ÎãàÎã§.
